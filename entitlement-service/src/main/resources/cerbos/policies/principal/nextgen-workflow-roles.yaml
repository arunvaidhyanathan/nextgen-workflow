# principal/nextgen-workflow-roles.yaml
# Role hierarchy and permissions for NextGen Workflow system roles
apiVersion: "api.cerbos.dev/v1"
principalPolicy:
  principal: "*"
  version: "1.0"
  rules:
    # ========================================
    # INTAKE ANALYST ROLES
    # ========================================
    - resource: "*"
      actions:
        - name: "*"
          effect: EFFECT_ALLOW
          condition:
            match:
              all:
                of:
                  - expr: request.principal.attr.isActive == true
                  - expr: |
                      "INTAKE_ANALYST" in request.principal.roles || 
                      "EO_INTAKE_ANALYST" in request.principal.roles

    # ========================================
    # MANAGEMENT ROLES (Higher Privileges)
    # ========================================
    - resource: "*"
      actions:
        - name: "*"
          effect: EFFECT_ALLOW
          condition:
            match:
              all:
                of:
                  - expr: request.principal.attr.isActive == true
                  - expr: |
                      "INVESTIGATION_MANAGER" in request.principal.roles ||
                      "EO_OFFICER" in request.principal.roles ||
                      "EO_HEAD" in request.principal.roles

    # ========================================
    # INVESTIGATOR ROLES
    # ========================================
    - resource: "case"
      actions:
        - name: "read"
          effect: EFFECT_ALLOW
          condition:
            match:
              all:
                of:
                  - expr: request.principal.attr.isActive == true
                  - expr: "INVESTIGATOR" in request.principal.roles
                  - expr: >
                      request.resource.attr.assigneeId == request.principal.id ||
                      request.resource.attr.department_code in request.principal.attr.departments
        - name: "update"
          effect: EFFECT_ALLOW
          condition:
            match:
              all:
                of:
                  - expr: request.principal.attr.isActive == true
                  - expr: "INVESTIGATOR" in request.principal.roles
                  - expr: >
                      request.resource.attr.assigneeId == request.principal.id ||
                      request.resource.attr.department_code in request.principal.attr.departments
        - name: "add_narrative"
          effect: EFFECT_ALLOW
          condition:
            match:
              all:
                of:
                  - expr: request.principal.attr.isActive == true
                  - expr: "INVESTIGATOR" in request.principal.roles
                  - expr: >
                      request.resource.attr.assigneeId == request.principal.id ||
                      request.resource.attr.department_code in request.principal.attr.departments

    # ========================================
    # DEPARTMENT-SPECIFIC ROLES
    # ========================================
    - resource: "case"
      actions:
        - name: "read"
          effect: EFFECT_ALLOW
          condition:
            match:
              all:
                of:
                  - expr: request.principal.attr.isActive == true
                  - expr: >
                      "HR_SPECIALIST" in request.principal.roles ||
                      "LEGAL_COUNSEL" in request.principal.roles ||
                      "SECURITY_ANALYST" in request.principal.roles
                  - expr: request.resource.attr.department_code in request.principal.attr.departments
        - name: "add_narrative"
          effect: EFFECT_ALLOW
          condition:
            match:
              all:
                of:
                  - expr: request.principal.attr.isActive == true
                  - expr: >
                      "HR_SPECIALIST" in request.principal.roles ||
                      "LEGAL_COUNSEL" in request.principal.roles ||
                      "SECURITY_ANALYST" in request.principal.roles
                  - expr: request.resource.attr.department_code in request.principal.attr.departments

    # ========================================
    # WORKFLOW TASK ROLES
    # ========================================
    - resource: "OneCMS::oneCmsUnifiedWorkflow"
      actions:
        - name: "claim_task"
          effect: EFFECT_ALLOW
          condition:
            match:
              all:
                of:
                  - expr: request.principal.attr.isActive == true
                  - expr: size(request.principal.attr.queues) > 0
                  - expr: >
                      request.resource.attr.currentTask.queue in request.principal.attr.queues ||
                      request.resource.attr.currentTask.assignee == request.principal.id
        - name: "complete_task"
          effect: EFFECT_ALLOW
          condition:
            match:
              all:
                of:
                  - expr: request.principal.attr.isActive == true
                  - expr: size(request.principal.attr.queues) > 0
                  - expr: >
                      request.resource.attr.currentTask.queue in request.principal.attr.queues ||
                      request.resource.attr.currentTask.assignee == request.principal.id
        - name: "view_task"
          effect: EFFECT_ALLOW
          condition:
            match:
              all:
                of:
                  - expr: request.principal.attr.isActive == true
                  - expr: size(request.principal.attr.queues) > 0
                  - expr: >
                      request.resource.attr.currentTask.queue in request.principal.attr.queues ||
                      request.resource.attr.currentTask.assignee == request.principal.id

    # ========================================
    # QUEUE ACCESS CONTROL
    # ========================================
    - resource: "OneCMS::oneCmsUnifiedWorkflow"
      actions:
        - name: "view_queue"
          effect: EFFECT_ALLOW
          condition:
            match:
              all:
                of:
                  - expr: request.principal.attr.isActive == true
                  - expr: request.resource.attr.currentQueue in request.principal.attr.queues
        - name: "list_queue_tasks"
          effect: EFFECT_ALLOW
          condition:
            match:
              all:
                of:
                  - expr: request.principal.attr.isActive == true
                  - expr: request.resource.attr.currentQueue in request.principal.attr.queues

    # ========================================
    # ADMIN AND AUDIT ROLES
    # ========================================
    - resource: "*"
      actions:
        - name: "audit"
          effect: EFFECT_ALLOW
          condition:
            match:
              all:
                of:
                  - expr: request.principal.attr.isActive == true
                  - expr: >
                      "EO_OFFICER" in request.principal.roles ||
                      "AROG_REVIEWER" in request.principal.roles
        - name: "export"
          effect: EFFECT_ALLOW
          condition:
            match:
              all:
                of:
                  - expr: request.principal.attr.isActive == true
                  - expr: >
                      "EO_OFFICER" in request.principal.roles ||
                      "AROG_REVIEWER" in request.principal.roles
        - name: "report"
          effect: EFFECT_ALLOW
          condition:
            match:
              all:
                of:
                  - expr: request.principal.attr.isActive == true
                  - expr: >
                      "EO_OFFICER" in request.principal.roles ||
                      "AROG_REVIEWER" in request.principal.roles
        - name: "delete"
          effect: EFFECT_ALLOW
          condition:
            match:
              all:
                of:
                  - expr: request.principal.attr.isActive == true
                  - expr: >
                      "EO_OFFICER" in request.principal.roles ||
                      "AROG_REVIEWER" in request.principal.roles

  # Default rule for role-based access
  defaultRule:
    effect: EFFECT_DENY