# resources/case.yaml
# Resource policy for OneCMS case management operations
# This policy governs actions on case business objects and is enforced by OneCMS Service
apiVersion: "api.cerbos.dev/v1"
resourcePolicy:
  resource: "case"
  version: "1.0"
  importDerivedRoles:
    - one_cms_derived_roles
  rules:
    # ========================================
    # CASE CREATION
    # ========================================
    - actions: ["create"]
      effect: EFFECT_ALLOW
      roles:
        - "user"               # Allow any authenticated user (for testing)
        - "INTAKE_ANALYST"     # Only intake analysts can create new cases
        - "EO_INTAKE_ANALYST"  # EO intake analysts can create cases

    # ========================================
    # CASE READING/VIEWING
    # ========================================
    - actions: ["read", "view"]
      effect: EFFECT_ALLOW
      roles:
        - "INTAKE_ANALYST"
        - "EO_INTAKE_ANALYST"   # EO intake analysts can view cases
        - "INVESTIGATOR" 
        - "INVESTIGATION_MANAGER"
        - "ADJUDICATOR"
        - "AROG_REVIEWER"
        - "EO_OFFICER"
        - "HR_SPECIALIST"
        - "LEGAL_COUNSEL"
        - "SECURITY_ANALYST"
      derivedRoles:
        # Allow department members to view cases assigned to their department
        - case_department_member

    # ========================================
    # CASE UPDATING
    # ========================================
    - actions: ["update", "edit"]
      effect: EFFECT_ALLOW
      roles:
        - "INVESTIGATION_MANAGER" # Managers can always update
        - "EO_OFFICER"           # Ethics office has broad update rights
        - "EO_INTAKE_ANALYST"    # EO intake analysts can update during intake process
      derivedRoles:
        # Allow current assignee to update their assigned case
        - case_assignee

    # ========================================
    # ALLEGATION MANAGEMENT
    # ========================================
    - actions: ["add_allegation"]
      effect: EFFECT_ALLOW
      roles:
        - "INTAKE_ANALYST"
        - "INVESTIGATION_MANAGER"
        - "INVESTIGATOR"
      derivedRoles:
        - case_assignee

    - actions: ["update_allegation"]
      effect: EFFECT_ALLOW
      roles:
        - "INVESTIGATION_MANAGER"
        - "INVESTIGATOR"
      derivedRoles:
        - case_assignee

    # ========================================
    # NARRATIVE MANAGEMENT
    # ========================================
    - actions: ["add_narrative", "create_narrative"]
      effect: EFFECT_ALLOW
      roles:
        - "INVESTIGATOR"
        - "INVESTIGATION_MANAGER"
        - "HR_SPECIALIST"
        - "LEGAL_COUNSEL"
        - "SECURITY_ANALYST"
      condition:
        match:
          # Only allow if user's department matches case department or they're assigned
          any:
            of:
              - expr: request.resource.attr.department_code in request.principal.attr.departments
              - expr: request.resource.attr.assigneeId == request.principal.id

    # ========================================
    # CASE ASSIGNMENT
    # ========================================
    - actions: ["assign", "reassign"]
      effect: EFFECT_ALLOW
      roles:
        - "INVESTIGATION_MANAGER"
        - "EO_OFFICER"

    # ========================================
    # CASE STATUS CHANGES
    # ========================================
    - actions: ["close_case", "reopen_case"]
      effect: EFFECT_ALLOW
      roles:
        - "INVESTIGATION_MANAGER"
        - "EO_OFFICER"

    # ========================================
    # SENSITIVE OPERATIONS
    # ========================================
    - actions: ["delete"]
      effect: EFFECT_ALLOW
      roles:
        - "EO_OFFICER" # Only ethics office can delete cases
      condition:
        match:
          # Additional safety check - only allow deletion of draft cases
          expr: request.resource.attr.status == "DRAFT"

    # ========================================
    # AUDIT AND REPORTING
    # ========================================
    - actions: ["audit", "export", "report"]
      effect: EFFECT_ALLOW
      roles:
        - "INVESTIGATION_MANAGER"
        - "EO_OFFICER"
        - "AROG_REVIEWER"

  # Default deny rule - all other actions are denied
  defaultRule:
    effect: EFFECT_DENY