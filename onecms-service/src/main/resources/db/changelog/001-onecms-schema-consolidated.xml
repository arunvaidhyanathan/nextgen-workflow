<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <!-- ========================================= -->
    <!-- CONSOLIDATED ONECMS DATABASE SCHEMA      -->
    <!-- Complete schema migration for OneCMS     -->
    <!-- ========================================= -->

    <!-- ========================================= -->
    <!-- 1. REFERENCE DATA TABLES                 -->
    <!-- ========================================= -->

    <changeSet id="001-create-reference-tables" author="onecms-consolidated">
        <comment>Create reference data tables for departments, case types, and lookup data</comment>
        
        <!-- Departments Table -->
        <createTable tableName="departments" schemaName="onecms">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="department_name" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="manager_email" type="VARCHAR(255)"/>
            <column name="active" type="BOOLEAN" defaultValue="true"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Case Types Table -->
        <createTable tableName="case_types" schemaName="onecms">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="type_name" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="active" type="BOOLEAN" defaultValue="true"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Countries and Clusters Table -->
        <createTable tableName="countries_clusters" schemaName="onecms">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="country_code" type="VARCHAR(10)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="country_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="cluster_name" type="VARCHAR(50)"/>
            <column name="region" type="VARCHAR(50)"/>
            <column name="is_active" type="BOOLEAN" defaultValue="true"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Data Sources Table -->
        <createTable tableName="data_sources" schemaName="onecms">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="source_code" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="source_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="is_active" type="BOOLEAN" defaultValue="true"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Escalation Methods Table -->
        <createTable tableName="escalation_methods" schemaName="onecms">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="method_code" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="method_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="is_active" type="BOOLEAN" defaultValue="true"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Create indexes for reference tables -->
        <createIndex tableName="case_types" schemaName="onecms" indexName="idx_case_types_name">
            <column name="type_name"/>
        </createIndex>
        <createIndex tableName="countries_clusters" schemaName="onecms" indexName="idx_countries_code">
            <column name="country_code"/>
        </createIndex>
        <createIndex tableName="data_sources" schemaName="onecms" indexName="idx_data_sources_code">
            <column name="source_code"/>
        </createIndex>
        <createIndex tableName="escalation_methods" schemaName="onecms" indexName="idx_escalation_methods_code">
            <column name="method_code"/>
        </createIndex>
    </changeSet>

    <!-- ========================================= -->
    <!-- 2. MAIN CASES TABLE                      -->
    <!-- ========================================= -->

    <changeSet id="002-create-cases-table" author="onecms-consolidated">
        <comment>Create main cases table with comprehensive case management fields</comment>
        
        <createTable tableName="cases" schemaName="onecms">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="case_number" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="title" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="status" type="VARCHAR(50)" defaultValue="OPEN">
                <constraints nullable="false"/>
            </column>
            <column name="priority" type="VARCHAR(20)" defaultValue="MEDIUM">
                <constraints nullable="false"/>
            </column>
            <column name="case_type_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="department_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="assigned_to" type="VARCHAR(255)"/>
            <column name="process_instance_id" type="VARCHAR(64)"/>
            <column name="workflow_instance_key" type="BIGINT"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            
            <!-- Additional case fields from frontend requirements -->
            <column name="complainant_name" type="VARCHAR(200)"/>
            <column name="complainant_email" type="VARCHAR(255)"/>
            <column name="occurrence_date" type="DATE"/>
            <column name="date_reported_to_citi" type="DATE"/>
            <column name="date_received_by_escalation_channel" type="DATE"/>
            <column name="complaint_escalated_by" type="VARCHAR(50)"/>
            <column name="data_source_id" type="VARCHAR(50)"/>
            <column name="cluster_country" type="VARCHAR(50)"/>
            <column name="legal_hold" type="BOOLEAN" defaultValue="false"/>
            <column name="outside_counsel" type="BOOLEAN" defaultValue="false"/>
            <column name="intake_analyst_id" type="VARCHAR(50)"/>
            <column name="investigation_manager_id" type="VARCHAR(50)"/>
            <column name="investigator_id" type="VARCHAR(50)"/>
        </createTable>

        <!-- Foreign Key Constraints -->
        <addForeignKeyConstraint
            baseTableName="cases" baseColumnNames="case_type_id" baseTableSchemaName="onecms"
            constraintName="fk_cases_case_type"
            referencedTableName="case_types" referencedColumnNames="id" referencedTableSchemaName="onecms"
            onDelete="RESTRICT"/>

        <addForeignKeyConstraint
            baseTableName="cases" baseColumnNames="department_id" baseTableSchemaName="onecms"
            constraintName="fk_cases_department"
            referencedTableName="departments" referencedColumnNames="id" referencedTableSchemaName="onecms"
            onDelete="RESTRICT"/>
            
        <!-- Performance Indexes -->
        <createIndex tableName="cases" schemaName="onecms" indexName="idx_cases_status">
            <column name="status"/>
        </createIndex>
        <createIndex tableName="cases" schemaName="onecms" indexName="idx_cases_priority">
            <column name="priority"/>
        </createIndex>
        <createIndex tableName="cases" schemaName="onecms" indexName="idx_cases_assigned_to">
            <column name="assigned_to"/>
        </createIndex>
        <createIndex tableName="cases" schemaName="onecms" indexName="idx_cases_created_at">
            <column name="created_at"/>
        </createIndex>
        <createIndex tableName="cases" schemaName="onecms" indexName="idx_cases_workflow_instance">
            <column name="workflow_instance_key"/>
        </createIndex>
        <createIndex tableName="cases" schemaName="onecms" indexName="idx_cases_status_priority">
            <column name="status"/>
            <column name="priority"/>
        </createIndex>
        <createIndex tableName="cases" schemaName="onecms" indexName="idx_cases_department_status">
            <column name="department_id"/>
            <column name="status"/>
        </createIndex>
    </changeSet>

    <!-- ========================================= -->
    <!-- 3. ALLEGATIONS TABLE                     -->
    <!-- ========================================= -->

    <changeSet id="003-create-allegations-table" author="onecms-consolidated">
        <comment>Create allegations table for case-related allegations and incidents</comment>
        
        <createTable tableName="allegations" schemaName="onecms">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="allegation_id" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="case_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="allegation_type" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="severity" type="VARCHAR(20)" defaultValue="MEDIUM">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(50)" defaultValue="OPEN">
                <constraints nullable="false"/>
            </column>
            <column name="department_classification" type="VARCHAR(100)"/>
            <column name="assigned_group" type="VARCHAR(100)"/>
            <column name="flowable_plan_item_id" type="VARCHAR(255)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            
            <!-- Additional fields from frontend requirements -->
            <column name="allegation_number" type="VARCHAR(100)"/>
            <column name="investigation_function" type="VARCHAR(50)"/>
            <column name="subject_entity_id" type="VARCHAR(50)"/>
            <column name="allegation_category" type="VARCHAR(20)"/>
            <column name="grc_taxonomy_1" type="VARCHAR(100)"/>
            <column name="grc_taxonomy_2" type="VARCHAR(100)"/>
            <column name="grc_taxonomy_3" type="VARCHAR(100)"/>
            <column name="grc_taxonomy_4" type="VARCHAR(100)"/>
        </createTable>

        <!-- Foreign Key Constraint -->
        <addForeignKeyConstraint
            baseTableName="allegations" baseColumnNames="case_id" baseTableSchemaName="onecms"
            constraintName="fk_allegations_case"
            referencedTableName="cases" referencedColumnNames="id" referencedTableSchemaName="onecms"
            onDelete="CASCADE"/>
        
        <!-- Performance Indexes -->
        <createIndex tableName="allegations" schemaName="onecms" indexName="idx_allegations_case_id">
            <column name="case_id"/>
        </createIndex>
        <createIndex tableName="allegations" schemaName="onecms" indexName="idx_allegations_status">
            <column name="status"/>
        </createIndex>
        <createIndex tableName="allegations" schemaName="onecms" indexName="idx_allegations_severity">
            <column name="severity"/>
        </createIndex>
        <createIndex tableName="allegations" schemaName="onecms" indexName="idx_allegations_category">
            <column name="allegation_category"/>
        </createIndex>
        <createIndex tableName="allegations" schemaName="onecms" indexName="idx_allegations_case_severity">
            <column name="case_id"/>
            <column name="severity"/>
        </createIndex>
    </changeSet>

    <!-- ========================================= -->
    <!-- 4. CASE ENTITIES TABLE                   -->
    <!-- ========================================= -->

    <changeSet id="004-create-case-entities-table" author="onecms-consolidated">
        <comment>Create case_entities table for people and organizations involved in cases</comment>
        
        <createTable tableName="case_entities" schemaName="onecms">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="entity_id" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="case_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="entity_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="role" type="VARCHAR(100)"/>
            <column name="details" type="JSONB"/>
            <column name="relationship_type" type="VARCHAR(100)"/>
            <column name="investigation_function" type="VARCHAR(50)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            
            <!-- Person-specific fields -->
            <column name="soeid" type="VARCHAR(50)"/>
            <column name="geid" type="VARCHAR(50)"/>
            <column name="first_name" type="VARCHAR(100)"/>
            <column name="middle_name" type="VARCHAR(100)"/>
            <column name="last_name" type="VARCHAR(100)"/>
            <column name="email_address" type="VARCHAR(255)"/>
            <column name="phone_number" type="VARCHAR(50)"/>
            <column name="address" type="TEXT"/>
            <column name="city" type="VARCHAR(100)"/>
            <column name="state" type="VARCHAR(100)"/>
            <column name="zip_code" type="VARCHAR(20)"/>
            
            <!-- Organization-specific fields -->
            <column name="organization_name" type="VARCHAR(255)"/>
            <column name="organization_type" type="VARCHAR(100)"/>
            
            <!-- Additional UI fields -->
            <column name="preferred_contact_method" type="TEXT"/>
            <column name="goc" type="VARCHAR(100)"/>
            <column name="manager" type="VARCHAR(255)"/>
            <column name="hire_date" type="DATE"/>
            <column name="hr_responsible" type="VARCHAR(255)"/>
            <column name="legal_vehicle" type="VARCHAR(100)"/>
            <column name="managed_segment" type="VARCHAR(100)"/>
            <column name="relationship_to_citi" type="VARCHAR(100)"/>
            <column name="anonymous" type="BOOLEAN" defaultValue="false"/>
        </createTable>

        <!-- Foreign Key Constraint -->
        <addForeignKeyConstraint
            baseTableName="case_entities" baseColumnNames="case_id" baseTableSchemaName="onecms"
            constraintName="fk_case_entities_case"
            referencedTableName="cases" referencedColumnNames="id" referencedTableSchemaName="onecms"
            onDelete="CASCADE"/>
        
        <!-- Performance Indexes -->
        <createIndex tableName="case_entities" schemaName="onecms" indexName="idx_case_entities_case_id">
            <column name="case_id"/>
        </createIndex>
        <createIndex tableName="case_entities" schemaName="onecms" indexName="idx_case_entities_type">
            <column name="entity_type"/>
        </createIndex>
        <createIndex tableName="case_entities" schemaName="onecms" indexName="idx_case_entities_soeid">
            <column name="soeid"/>
        </createIndex>
        <createIndex tableName="case_entities" schemaName="onecms" indexName="idx_case_entities_email">
            <column name="email_address"/>
        </createIndex>
    </changeSet>

    <!-- ========================================= -->
    <!-- 5. CASE NARRATIVES TABLE                 -->
    <!-- ========================================= -->

    <changeSet id="005-create-case-narratives-table" author="onecms-consolidated">
        <comment>Create case_narratives table for case investigation documentation</comment>
        
        <createTable tableName="case_narratives" schemaName="onecms">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="narrative_id" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="case_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="narrative_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="narrative_title" type="VARCHAR(255)"/>
            <column name="content" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="author" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="is_recalled" type="BOOLEAN" defaultValue="false"/>
            <column name="created_by" type="VARCHAR(50)"/>
            <column name="investigation_function" type="VARCHAR(50)"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Foreign Key Constraint -->
        <addForeignKeyConstraint
            baseTableName="case_narratives" baseColumnNames="case_id" baseTableSchemaName="onecms"
            constraintName="fk_case_narratives_case"
            referencedTableName="cases" referencedColumnNames="id" referencedTableSchemaName="onecms"
            onDelete="CASCADE"/>
        
        <!-- Performance Indexes -->
        <createIndex tableName="case_narratives" schemaName="onecms" indexName="idx_case_narratives_case_id">
            <column name="case_id"/>
        </createIndex>
        <createIndex tableName="case_narratives" schemaName="onecms" indexName="idx_case_narratives_type">
            <column name="narrative_type"/>
        </createIndex>
        <createIndex tableName="case_narratives" schemaName="onecms" indexName="idx_case_narratives_author">
            <column name="author"/>
        </createIndex>
        <createIndex tableName="case_narratives" schemaName="onecms" indexName="idx_case_narratives_created_by">
            <column name="created_by"/>
        </createIndex>
        
        <!-- Full text search index for narrative content -->
        <sql>
            CREATE INDEX IF NOT EXISTS idx_case_narratives_content_search 
            ON onecms.case_narratives USING gin(to_tsvector('english', content));
        </sql>
    </changeSet>

    <!-- ========================================= -->
    <!-- 6. CASE COMMENTS TABLE                   -->
    <!-- ========================================= -->

    <changeSet id="006-create-case-comments-table" author="onecms-consolidated">
        <comment>Create case_comments table for case discussions and communication</comment>
        
        <createTable tableName="case_comments" schemaName="onecms">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="comment_id" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="case_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="parent_comment_id" type="BIGINT"/>
            <column name="comment" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="comment_type" type="VARCHAR(50)" defaultValue="GENERAL">
                <constraints nullable="false"/>
            </column>
            <column name="visibility" type="VARCHAR(20)" defaultValue="INTERNAL">
                <constraints nullable="false"/>
            </column>
            <column name="author" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="updated_by" type="VARCHAR(50)"/>
            <column name="is_deleted" type="BOOLEAN" defaultValue="false"/>
            <column name="is_internal" type="BOOLEAN" defaultValue="false"/>
            <column name="is_confidential" type="BOOLEAN" defaultValue="false"/>
            <column name="character_count" type="INTEGER" defaultValue="0"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Foreign Key Constraints -->
        <addForeignKeyConstraint
            baseTableName="case_comments" baseColumnNames="case_id" baseTableSchemaName="onecms"
            constraintName="fk_case_comments_case"
            referencedTableName="cases" referencedColumnNames="id" referencedTableSchemaName="onecms"
            onDelete="CASCADE"/>
        
        <!-- Performance Indexes -->
        <createIndex tableName="case_comments" schemaName="onecms" indexName="idx_case_comments_case_id">
            <column name="case_id"/>
        </createIndex>
        <createIndex tableName="case_comments" schemaName="onecms" indexName="idx_case_comments_author">
            <column name="author"/>
        </createIndex>
        <createIndex tableName="case_comments" schemaName="onecms" indexName="idx_case_comments_created_by">
            <column name="created_by"/>
        </createIndex>
        <createIndex tableName="case_comments" schemaName="onecms" indexName="idx_case_comments_type">
            <column name="comment_type"/>
        </createIndex>
        <createIndex tableName="case_comments" schemaName="onecms" indexName="idx_case_comments_created_at">
            <column name="created_at"/>
        </createIndex>
        
        <!-- Full text search index for comment content -->
        <sql>
            CREATE INDEX IF NOT EXISTS idx_case_comments_text_search 
            ON onecms.case_comments USING gin(to_tsvector('english', comment));
        </sql>
    </changeSet>

    <!-- ========================================= -->
    <!-- 7. CASE TRANSITIONS TABLE                -->
    <!-- ========================================= -->

    <changeSet id="007-create-case-transitions-table" author="onecms-consolidated">
        <comment>Create case_transitions table for tracking case workflow state changes</comment>
        
        <createTable tableName="case_transitions" schemaName="onecms">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="transition_id" type="BIGINT">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="case_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="from_status" type="VARCHAR(50)"/>
            <column name="to_status" type="VARCHAR(50)"/>
            <column name="task_definition_key" type="VARCHAR(100)"/>
            <column name="task_name" type="VARCHAR(200)"/>
            <column name="workflow_instance_key" type="BIGINT"/>
            <column name="task_key" type="BIGINT"/>
            <column name="performed_by_user_id" type="VARCHAR(50)"/>
            <column name="transition_date" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="comments" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Foreign Key Constraint -->
        <addForeignKeyConstraint
            baseTableName="case_transitions" baseColumnNames="case_id" baseTableSchemaName="onecms"
            constraintName="fk_case_transitions_case"
            referencedTableName="cases" referencedColumnNames="id" referencedTableSchemaName="onecms"
            onDelete="CASCADE"/>
        
        <!-- Performance Indexes -->
        <createIndex tableName="case_transitions" schemaName="onecms" indexName="idx_case_transitions_case_id">
            <column name="case_id"/>
        </createIndex>
        <createIndex tableName="case_transitions" schemaName="onecms" indexName="idx_case_transitions_transition_date">
            <column name="transition_date"/>
        </createIndex>
        <createIndex tableName="case_transitions" schemaName="onecms" indexName="idx_case_transitions_performed_by">
            <column name="performed_by_user_id"/>
        </createIndex>
        <createIndex tableName="case_transitions" schemaName="onecms" indexName="idx_case_transitions_workflow">
            <column name="workflow_instance_key"/>
        </createIndex>
        
        <!-- Composite index for common queries -->
        <createIndex tableName="case_transitions" schemaName="onecms" indexName="idx_case_transitions_case_status">
            <column name="case_id"/>
            <column name="to_status"/>
            <column name="transition_date"/>
        </createIndex>
    </changeSet>
    
    <!-- ========================================= -->
    <!-- 8. TRANSITION ID SEQUENCE                -->
    <!-- ========================================= -->
    
    <changeSet id="008-create-transition-id-sequence" author="onecms-consolidated">
        <comment>Create sequence for transition_id to ensure unique identifiers</comment>
        
        <createSequence schemaName="onecms" sequenceName="case_transitions_transition_id_seq" 
                       startValue="1" incrementBy="1" minValue="1" maxValue="9223372036854775807" 
                       cacheSize="1" cycle="false"/>
    </changeSet>
    
    <!-- ========================================= -->
    <!-- 9. UPDATED_AT TRIGGER                    -->
    <!-- ========================================= -->
    
    <changeSet id="009-create-updated-at-trigger" author="onecms-consolidated">
        <comment>Add trigger to automatically update updated_at timestamp on row updates</comment>
        
        <sql>
            CREATE OR REPLACE FUNCTION onecms.update_case_transitions_updated_at()
            RETURNS TRIGGER AS $$
            BEGIN
                NEW.updated_at = CURRENT_TIMESTAMP;
                RETURN NEW;
            END;
            $$ LANGUAGE plpgsql;
            
            CREATE TRIGGER case_transitions_updated_at_trigger
                BEFORE UPDATE ON onecms.case_transitions
                FOR EACH ROW
                EXECUTE FUNCTION onecms.update_case_transitions_updated_at();
        </sql>
        
        <rollback>
            DROP TRIGGER IF EXISTS case_transitions_updated_at_trigger ON onecms.case_transitions;
            DROP FUNCTION IF EXISTS onecms.update_case_transitions_updated_at();
        </rollback>
    </changeSet>

    <!-- ========================================= -->
    <!-- 10. TRANSITION VARIABLES TABLE           -->
    <!-- ========================================= -->

    <changeSet id="010-create-transition-variables-table" author="onecms-consolidated">
        <comment>Create transition_variables table for storing case transition variables</comment>
        
        <createTable tableName="transition_variables" schemaName="onecms">
            <column name="case_transitions_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="variable_name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="variable_value" type="VARCHAR(500)"/>
        </createTable>
        
        <!-- Composite Primary Key -->
        <addPrimaryKey 
            tableName="transition_variables" 
            schemaName="onecms" 
            columnNames="case_transitions_id,variable_name" 
            constraintName="pk_transition_variables"/>
        
        <!-- Foreign Key Constraint -->
        <addForeignKeyConstraint
            baseTableName="transition_variables" baseColumnNames="case_transitions_id" baseTableSchemaName="onecms"
            constraintName="fk_transition_variables_transition"
            referencedTableName="case_transitions" referencedColumnNames="id" referencedTableSchemaName="onecms"
            onDelete="CASCADE"/>
    </changeSet>

    <!-- ========================================= -->
    <!-- 11. WORK ITEMS TABLE                     -->
    <!-- ========================================= -->

    <changeSet id="011-create-work-items-table" author="onecms-consolidated">
        <comment>Create work_items table for case tasks and work items</comment>
        
        <createTable tableName="work_items" schemaName="onecms">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="work_item_id" type="VARCHAR(20)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="case_id" type="BIGINT"/>
            <column name="assigned_to_user_id" type="VARCHAR(50)"/>
            <column name="task_name" type="VARCHAR(200)">
                <constraints nullable="false"/>
            </column>
            <column name="task_type" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="task_key" type="BIGINT"/>
            <column name="status" type="VARCHAR(50)" defaultValue="PENDING"/>
            <column name="due_date" type="DATE"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="completed_at" type="TIMESTAMP"/>
            <column name="completed_by_user_id" type="VARCHAR(50)"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Foreign Key Constraint -->
        <addForeignKeyConstraint
            baseTableName="work_items" baseColumnNames="case_id" baseTableSchemaName="onecms"
            constraintName="fk_work_items_case"
            referencedTableName="cases" referencedColumnNames="id" referencedTableSchemaName="onecms"
            onDelete="CASCADE"/>
        
        <!-- Performance Indexes -->
        <createIndex tableName="work_items" schemaName="onecms" indexName="idx_work_items_case_id">
            <column name="case_id"/>
        </createIndex>
        <createIndex tableName="work_items" schemaName="onecms" indexName="idx_work_items_assigned_to">
            <column name="assigned_to_user_id"/>
        </createIndex>
        <createIndex tableName="work_items" schemaName="onecms" indexName="idx_work_items_status">
            <column name="status"/>
        </createIndex>
        <createIndex tableName="work_items" schemaName="onecms" indexName="idx_work_items_due_date">
            <column name="due_date"/>
        </createIndex>
        <createIndex tableName="work_items" schemaName="onecms" indexName="idx_work_items_task_key">
            <column name="task_key"/>
        </createIndex>
        <createIndex tableName="work_items" schemaName="onecms" indexName="idx_work_items_assigned_status">
            <column name="assigned_to_user_id"/>
            <column name="status"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>