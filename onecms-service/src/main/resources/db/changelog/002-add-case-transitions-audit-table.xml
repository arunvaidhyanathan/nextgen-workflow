<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <!-- ======================================= -->
    <!-- ADD CASE TRANSITIONS AUDIT TABLE       -->  
    <!-- ======================================= -->
    <!-- This migration adds the case_transitions table for audit trail tracking -->
    <!-- Author: Database Performance Optimization -->
    <!-- Date: 2025-08-11 -->
    
    <changeSet id="002-add-case-transitions-table" author="claude-code">
        <comment>Add case_transitions table for comprehensive audit trail of case status changes and workflow transitions</comment>
        
        <createTable tableName="case_transitions" schemaName="onecms">
            <column name="id" type="BIGSERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="transition_id" type="BIGINT">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="case_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="from_status" type="VARCHAR(50)">
                <constraints nullable="true"/>
            </column>
            <column name="to_status" type="VARCHAR(50)">
                <constraints nullable="true"/>
            </column>
            <column name="task_definition_key" type="VARCHAR(100)">
                <constraints nullable="true"/>
            </column>
            <column name="task_name" type="VARCHAR(200)">
                <constraints nullable="true"/>
            </column>
            <column name="workflow_instance_key" type="BIGINT">
                <constraints nullable="true"/>
            </column>
            <column name="task_key" type="BIGINT">
                <constraints nullable="true"/>
            </column>
            <column name="performed_by_user_id" type="VARCHAR(50)">
                <constraints nullable="true"/>
            </column>
            <column name="transition_date" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="comments" type="TEXT">
                <constraints nullable="true"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- Add foreign key constraint to cases table -->
        <addForeignKeyConstraint
            baseTableSchemaName="onecms"
            baseTableName="case_transitions"
            baseColumnNames="case_id"
            constraintName="fk_case_transitions_case_id"
            referencedTableSchemaName="onecms"
            referencedTableName="cases"
            referencedColumnNames="id"
            onDelete="CASCADE"
            onUpdate="CASCADE"/>
        
        <!-- Add indexes for performance -->
        <createIndex tableName="case_transitions" schemaName="onecms" indexName="idx_case_transitions_case_id">
            <column name="case_id"/>
        </createIndex>
        
        <createIndex tableName="case_transitions" schemaName="onecms" indexName="idx_case_transitions_transition_date">
            <column name="transition_date"/>
        </createIndex>
        
        <createIndex tableName="case_transitions" schemaName="onecms" indexName="idx_case_transitions_performed_by">
            <column name="performed_by_user_id"/>
        </createIndex>
        
        <createIndex tableName="case_transitions" schemaName="onecms" indexName="idx_case_transitions_workflow">
            <column name="workflow_instance_key"/>
        </createIndex>
        
        <!-- Composite index for common queries -->
        <createIndex tableName="case_transitions" schemaName="onecms" indexName="idx_case_transitions_case_status">
            <column name="case_id"/>
            <column name="to_status"/>
            <column name="transition_date"/>
        </createIndex>
    </changeSet>
    
    <!-- Add sequence for transition_id if needed (PostgreSQL auto-generates, but explicit for clarity) -->
    <changeSet id="002-add-transition-id-sequence" author="claude-code">
        <comment>Create sequence for transition_id to ensure unique identifiers</comment>
        
        <createSequence schemaName="onecms" sequenceName="case_transitions_transition_id_seq" 
                       startValue="1" incrementBy="1" minValue="1" maxValue="9223372036854775807" 
                       cacheSize="1" cycle="false"/>
    </changeSet>
    
    <!-- Add trigger to auto-update updated_at timestamp -->
    <changeSet id="002-add-updated-at-trigger" author="claude-code">
        <comment>Add trigger to automatically update updated_at timestamp on row updates</comment>
        
        <sql>
            CREATE OR REPLACE FUNCTION onecms.update_case_transitions_updated_at()
            RETURNS TRIGGER AS $$
            BEGIN
                NEW.updated_at = CURRENT_TIMESTAMP;
                RETURN NEW;
            END;
            $$ LANGUAGE plpgsql;
            
            CREATE TRIGGER case_transitions_updated_at_trigger
                BEFORE UPDATE ON onecms.case_transitions
                FOR EACH ROW
                EXECUTE FUNCTION onecms.update_case_transitions_updated_at();
        </sql>
        
        <rollback>
            DROP TRIGGER IF EXISTS case_transitions_updated_at_trigger ON onecms.case_transitions;
            DROP FUNCTION IF EXISTS onecms.update_case_transitions_updated_at();
        </rollback>
    </changeSet>
    
</databaseChangeLog>