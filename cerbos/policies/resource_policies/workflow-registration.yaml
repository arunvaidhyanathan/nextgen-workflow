---
apiVersion: api.cerbos.dev/v1
resourcePolicy:
  resource: "workflow-registration"
  version: "1_0"
  importDerivedRoles:
    - common_roles
    - one_cms_roles
    
  rules:
    # ========================================
    # WORKFLOW REGISTRATION MANAGEMENT
    # ========================================
    
    # Enterprise Admins can register, deploy, and manage all workflows
    - actions: ["register", "deploy", "view", "update", "delete"]
      effect: EFFECT_ALLOW
      roles: ["ENTERPRISE_ADMIN", "SYSTEM_ADMIN"]
      condition:
        match:
          expr: request.principal.attr.isActive == true

    # EO Head can register and deploy EO-related workflows
    - actions: ["register", "deploy", "view"]
      effect: EFFECT_ALLOW
      roles: ["EO_HEAD"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: '"EO" in request.principal.attr.departments'

    # Investigation Managers can view workflow metadata for investigation processes
    - actions: ["view"]
      effect: EFFECT_ALLOW
      roles: ["INVESTIGATION_MANAGER"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: '"IU" in request.principal.attr.departments'

    # Department analysts can view workflow metadata related to their departments
    - actions: ["view"]
      effect: EFFECT_ALLOW
      roles: ["CSIS_INTAKE_ANALYST", "ER_INTAKE_ANALYST", "LEGAL_INTAKE_ANALYST"]
      condition:
        match:
          expr: request.principal.attr.isActive == true

    # EO Officers and Intake Analysts can view workflow metadata
    - actions: ["view"]
      effect: EFFECT_ALLOW
      roles: ["EO_OFFICER", "EO_INTAKE_ANALYST"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: '"EO" in request.principal.attr.departments'

    # Default deny all other actions
    - actions: ["*"]
      effect: EFFECT_DENY
      roles: ["*"]