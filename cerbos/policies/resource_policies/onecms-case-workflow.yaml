---
apiVersion: api.cerbos.dev/v1
resourcePolicy:
  version: "1_0"
  resource: "oneCmsCaseWorkflow"
  importDerivedRoles:
    - one_cms_roles
  
  rules:
    # ========================================
    # WORKFLOW INSTANCE MANAGEMENT
    # ========================================
    - actions: ['start_workflow_instance', 'initiate_process']
      effect: EFFECT_ALLOW
      roles:
        - 'EO_INTAKE_ANALYST'  # Only EO Intake can start new workflow instances
      condition:
        match:
          expr: request.principal.attr.isActive == true

    - actions: ['terminate_workflow', 'cancel_process', 'suspend_process', 'activate_process']
      effect: EFFECT_ALLOW
      roles:
        - 'EO_OFFICER'         # EO Officer can control workflow lifecycle
        - 'EO_HEAD'            # EO Head has administrative control
        - 'INVESTIGATION_MANAGER'  # Investigation Manager can suspend investigations
      condition:
        match:
          expr: request.principal.attr.isActive == true

    # ========================================
    # QUEUE ACCESS MANAGEMENT
    # ========================================
    - actions: ['view_queue', 'list_queue_tasks']
      effect: EFFECT_ALLOW
      roles: ['*']  # All authenticated users with queue access
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: has(request.principal.attr.queues)
              - expr: request.resource.attr.currentQueue in request.principal.attr.queues

    # ========================================
    # TASK MANAGEMENT BY ROLE
    # ========================================
    
    # EO Intake Analyst - Case Creation Phase
    - actions: ['create_case', 'add_allegation', 'add_narrative', 'add_entity', 'cancel_case', 'assign_to_eo_officer', 'save_and_reject_case']
      effect: EFFECT_ALLOW
      roles: ['EO_INTAKE_ANALYST']
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: '"eo-intake-analyst-queue" in request.principal.attr.queues'

    # EO Head - Case Assignment Phase  
    - actions: ['assign_case', 'view_case', 'reassign_case']
      effect: EFFECT_ALLOW
      roles: ['EO_HEAD']
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: '"eo-head-queue" in request.principal.attr.queues'

    # EO Officer - Routing Phase
    - actions: ['view_case', 'add_narrative', 'add_allegation', 'send_back_to_intake', 'route_to_investigation_unit', 'route_to_department', 'save_case', 'reject_case', 'mark_non_tracked']
      effect: EFFECT_ALLOW
      roles: ['EO_OFFICER']
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: '"eo-officer-queue" in request.principal.attr.queues'

    # Department Intake Analysts - Review Phase
    - actions: ['view_case', 'add_info', 'add_narrative', 'add_allegation', 'add_entity', 'send_back_to_eo', 'assign_to_investigation_manager', 'save_and_close_case']
      effect: EFFECT_ALLOW
      roles: ['CSIS_INTAKE_ANALYST', 'ER_INTAKE_ANALYST', 'LEGAL_INTAKE_ANALYST']
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: |
                  ("csis-intake-analyst-queue" in request.principal.attr.queues && "CSIS" in request.principal.attr.departments) ||
                  ("er-intake-analyst-queue" in request.principal.attr.queues && "HR" in request.principal.attr.departments) ||
                  ("legal-intake-analyst-queue" in request.principal.attr.queues && "LEGAL" in request.principal.attr.departments)

    # Investigation Manager - Assignment Phase
    - actions: ['view_case', 'add_narrative', 'add_allegation', 'add_entity', 'send_back_to_department', 'assign_to_investigator', 'save_and_close_case']
      effect: EFFECT_ALLOW
      roles: ['INVESTIGATION_MANAGER']
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: '"investigation-manager-queue" in request.principal.attr.queues'
              - expr: '"IU" in request.principal.attr.departments'

    # Investigator - Investigation Phase
    - actions: ['view_case', 'add_narrative', 'add_allegation', 'add_entity', 'send_back_to_manager', 'start_active_investigation', 'save_and_close_case']
      effect: EFFECT_ALLOW
      roles: ['INVESTIGATOR']
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: '"investigator-queue" in request.principal.attr.queues'
              - expr: '"IU" in request.principal.attr.departments'

    # ========================================
    # STANDARD TASK OPERATIONS
    # ========================================
    - actions: ['view_task', 'read_task']
      effect: EFFECT_ALLOW
      roles: ['*']
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: request.resource.attr.currentTask.queue in request.principal.attr.queues

    - actions: ['claim_task', 'assign_to_self']
      effect: EFFECT_ALLOW
      roles: ['*']
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: request.resource.attr.currentTask.queue in request.principal.attr.queues
              - expr: request.resource.attr.currentTask.assignee == null

    - actions: ['complete_task', 'finish_task']
      effect: EFFECT_ALLOW
      roles: ['*']
      derivedRoles:
        - task_assignee
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: request.resource.attr.currentTask.assignee == request.principal.id

    # ========================================
    # DELEGATION AND ESCALATION
    # ========================================
    - actions: ['delegate_task', 'reassign_task', 'escalate_task']
      effect: EFFECT_ALLOW
      roles:
        - 'EO_HEAD'
        - 'EO_OFFICER'
        - 'INVESTIGATION_MANAGER'
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: |
                  request.resource.attr.currentTask.queue in request.principal.attr.queues ||
                  request.resource.attr.currentTask.assignee == request.principal.id

    # ========================================
    # AUDIT AND REPORTING
    # ========================================
    - actions: ['view_task_history', 'view_audit_trail', 'audit', 'export', 'report']
      effect: EFFECT_ALLOW
      roles:
        - 'EO_HEAD'
        - 'EO_OFFICER'
        - 'INVESTIGATION_MANAGER'
        - 'ENTERPRISE_ADMIN'
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: |
                  request.resource.attr.currentTask.queue in request.principal.attr.queues ||
                  "admin" in request.principal.attr

    # ========================================
    # PROCESS VARIABLE ACCESS
    # ========================================
    - actions: ['read_process_variables', 'view_variables']
      effect: EFFECT_ALLOW
      roles: ['*']
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: |
                  request.resource.attr.currentQueue in request.principal.attr.queues ||
                  request.resource.attr.currentTask.assignee == request.principal.id

    - actions: ['update_process_variables', 'set_variables']
      effect: EFFECT_ALLOW
      roles:
        - 'EO_OFFICER'
        - 'INVESTIGATION_MANAGER'
        - 'ENTERPRISE_ADMIN'
      derivedRoles:
        - task_assignee
      condition:
        match:
          expr: request.principal.attr.isActive == true

    # Default deny all other actions
    - actions: ['*']
      roles: ['*']
      effect: EFFECT_DENY