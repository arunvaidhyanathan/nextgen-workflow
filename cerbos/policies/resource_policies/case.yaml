---
apiVersion: api.cerbos.dev/v1
resourcePolicy:
  resource: "case"
  version: "1_1"
  importDerivedRoles:
    - common_roles
    - one_cms_roles
    
  rules:
    # ========================================
    # CASE CREATION (EO Intake Phase)
    # ========================================
    - actions: ["create", "create_case"]
      effect: EFFECT_ALLOW
      roles: ["EO_INTAKE_ANALYST", "user"] # user for testing compatibility
      condition:
        match:
          expr: request.principal.attr.isActive == true
      
    # ========================================
    # CASE VIEWING - Role-based access
    # ========================================
    - actions: ["view", "read", "view_case"]
      effect: EFFECT_ALLOW
      roles: ["EO_INTAKE_ANALYST", "EO_HEAD", "EO_OFFICER", "CSIS_INTAKE_ANALYST", "ER_INTAKE_ANALYST", "LEGAL_INTAKE_ANALYST", "INVESTIGATION_MANAGER", "INVESTIGATOR"]
      derivedRoles: ["case_assignee", "case_department_member", "case_creator", "unit_manager"]
      condition:
        match:
          expr: |
            request.principal.attr.isActive == true &&
            (request.resource.attr.department_code in request.principal.attr.departments ||
             request.resource.attr.assigneeId == request.principal.id ||
             request.resource.attr.createdBy == request.principal.id)
      
    # ========================================
    # EO INTAKE ANALYST ACTIONS
    # ========================================
    - actions: ["add_allegation", "add_narrative", "add_entity", "cancel_case", "assign_to_eo_officer", "save_and_reject_case"]
      effect: EFFECT_ALLOW
      roles: ["EO_INTAKE_ANALYST"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: |
                  request.resource.attr.createdBy == request.principal.id ||
                  request.resource.attr.assigneeId == request.principal.id ||
                  request.resource.attr.status == "DRAFT"

    # ========================================
    # EO HEAD ACTIONS  
    # ========================================
    - actions: ["assign", "assign_case", "reassign", "reassign_case", "approveClosure", "rejectClosure"]
      effect: EFFECT_ALLOW
      roles: ["EO_HEAD"]
      derivedRoles: ["unit_manager"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: '"EO" in request.principal.attr.departments'

    # ========================================
    # EO OFFICER ACTIONS
    # ========================================
    - actions: ["add_narrative", "add_allegation", "send_back_to_intake", "route_to_investigation_unit", "route_to_department", "save_case", "reject_case", "mark_non_tracked"]
      effect: EFFECT_ALLOW
      roles: ["EO_OFFICER"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: '"EO" in request.principal.attr.departments'
              - expr: |
                  request.resource.attr.assigneeId == request.principal.id ||
                  request.resource.attr.status in ["ASSIGNED", "UNDER_REVIEW"]

    # ========================================
    # DEPARTMENT INTAKE ANALYST ACTIONS
    # ========================================
    - actions: ["add_info", "add_narrative", "add_allegation", "add_entity", "send_back_to_eo", "assign_to_investigation_manager", "save_and_close_case"]
      effect: EFFECT_ALLOW
      roles: ["CSIS_INTAKE_ANALYST", "ER_INTAKE_ANALYST", "LEGAL_INTAKE_ANALYST"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: |
                  (request.resource.attr.assigneeId == request.principal.id) ||
                  (request.resource.attr.department_code in request.principal.attr.departments)

    # ========================================
    # INVESTIGATION MANAGER ACTIONS
    # ========================================
    - actions: ["assign_to_investigator", "assignInvestigator", "send_back_to_department", "review", "save_and_close_case"]
      effect: EFFECT_ALLOW
      roles: ["INVESTIGATION_MANAGER", "ER_INVESTIGATION_MANAGER", "CSIS_INVESTIGATION_MANAGER"]
      derivedRoles: ["unit_manager"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: |
                  (request.resource.attr.assigneeId == request.principal.id) ||
                  ("IU" in request.principal.attr.departments)

    # ========================================
    # INVESTIGATOR ACTIONS
    # ========================================
    - actions: ["start_active_investigation", "send_back_to_manager", "save_and_close_case"]
      effect: EFFECT_ALLOW
      roles: ["INVESTIGATOR"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: |
                  (request.resource.attr.assigneeId == request.principal.id) ||
                  ("IU" in request.principal.attr.departments)

    # ========================================
    # COMMON CASE ACTIONS (All Workflow Actors)
    # ========================================
    - actions: ["update", "edit", "addComment", "addNarrative"]
      effect: EFFECT_ALLOW
      roles: ["EO_INTAKE_ANALYST", "EO_HEAD", "EO_OFFICER", "CSIS_INTAKE_ANALYST", "ER_INTAKE_ANALYST", "LEGAL_INTAKE_ANALYST", "INVESTIGATION_MANAGER", "INVESTIGATOR"]
      derivedRoles: ["case_assignee", "unit_manager"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: |
                  request.resource.attr.assigneeId == request.principal.id ||
                  request.resource.attr.department_code in request.principal.attr.departments ||
                  request.resource.attr.createdBy == request.principal.id

    # ========================================
    # WORKFLOW PHASE TRANSITIONS
    # ========================================
    - actions: ["submitForInvestigation", "submitForReview"]
      effect: EFFECT_ALLOW
      derivedRoles: ["case_assignee", "unit_manager"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: |
                  has(request.resource.attr.phase) && 
                  request.resource.attr.phase == "INTAKE" &&
                  (request.resource.attr.assigneeId == request.principal.id ||
                   request.resource.attr.department_code in request.principal.attr.departments)

    # ========================================
    # CASE STATUS MANAGEMENT
    # ========================================
    - actions: ["close_case", "reopen_case", "closeCase", "reopenCase"]
      effect: EFFECT_ALLOW
      roles: ["EO_HEAD", "EO_OFFICER", "INVESTIGATION_MANAGER"]
      derivedRoles: ["unit_manager"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: |
                  request.resource.attr.department_code in request.principal.attr.departments ||
                  request.resource.attr.assigneeId == request.principal.id

    # ========================================
    # MULTI-DEPARTMENT COORDINATION
    # ========================================
    - actions: ["coordinate", "assign"]
      effect: EFFECT_ALLOW
      derivedRoles: ["multi_dept_coordinator"]
      roles: ["EO_OFFICER"]
      condition:
        match:
          expr: |
            request.principal.attr.isActive == true &&
            has(request.resource.attr.departments) &&
            size(request.resource.attr.departments) > 1

    # ========================================
    # SENSITIVE OPERATIONS
    # ========================================
    - actions: ["delete", "deleteCase"]
      effect: EFFECT_ALLOW
      roles: ["EO_HEAD", "ENTERPRISE_ADMIN"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: |
                  request.resource.attr.status == "DRAFT" ||
                  "admin" in request.principal.attr

    # ========================================
    # AUDIT AND REPORTING
    # ========================================
    - actions: ["audit", "export", "report", "view_audit_trail"]
      effect: EFFECT_ALLOW
      roles: ["EO_HEAD", "EO_OFFICER", "INVESTIGATION_MANAGER", "ENTERPRISE_ADMIN"]
      condition:
        match:
          all:
            of:
              - expr: request.principal.attr.isActive == true
              - expr: |
                  request.resource.attr.department_code in request.principal.attr.departments ||
                  "admin" in request.principal.attr

    # Default deny all other actions
    - actions: ["*"]
      roles: ["*"]
      effect: EFFECT_DENY